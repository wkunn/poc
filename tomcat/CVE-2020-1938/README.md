# CVE-2020-1938 Tomcat AJP漏洞复现
### 影响版本
Apache Tomcat 9.x < 9.0.31

Apache Tomcat 8.x < 8.5.51

Apache Tomcat 7.x < 7.0.100

Apache Tomcat 6.x

### 前提
对于处在漏洞影响版本范围内的 Tomcat 而言，若其开启 AJP Connector 且攻击者能够访问 AJP Connector 服务端口的情况下，即存在被 Ghostcat 漏洞利用的风险。注意 Tomcat AJP Connector 默认配置下即为开启状态，且监听在 0.0.0.0:8009 。

### 漏洞复现

tomcat默认的conf/server.xml中配置了2个Connector，一个为8080的对外提供的HTTP协议端口，另外一个就是默认的8009 AJP协议端口，两个端口默认均监听在外网ip。

![image](https://github.com/user-attachments/assets/bfc9931d-708d-468c-8feb-7674e7e2dd86)


![image](https://github.com/user-attachments/assets/d82602c0-a15e-4b85-b81a-8fcadd3486de)


tomcat在接收ajp请求的时候调用org.apache.coyote.ajp.AjpProcessor来处理ajp消息，prepareRequest将ajp里面的内容取出来设置成request对象的Attribute属性

如下图

![image](https://github.com/user-attachments/assets/3fb77e46-6dec-4970-9fac-2272464130a2)

此处是高版本的AjpProcessor.java的内容

![image](https://github.com/user-attachments/assets/7b62636a-ce7d-4d4d-8af3-5fe6a050c4fc)

因此可以通过此种特性从而可以控制request对象的下面三个Attribute属性

javax.servlet.include.request_uri

javax.servlet.include.path_info

javax.servlet.include.servlet_path

然后封装成对应的request之后,继续走servlet的映射流程如下图所示:

![image](https://github.com/user-attachments/assets/8a27f943-2034-4492-a68f-c3fd6d41cf87)



